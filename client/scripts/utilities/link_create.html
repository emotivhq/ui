<html>
<body>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/ramda/0.8.0/ramda.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script>
        window.onload = makeForm;
        var urlInput, titleInput, imgUrlInput, priceInput, referrerInput,
                resultInput, submitButton;

        function makeForm() {
            urlInput = document.getElementById('url');
            titleInput = document.getElementById('title');
            imgUrlInput = document.getElementById('image');
            priceInput = document.getElementById('price');
            referrerInput = document.getElementById('source');
            resultInput = document.getElementById('result');
            submitButton = document.getElementById('submit');
        }

        function formSubmit() {
            var url = makeUrl(urlInput.value, titleInput.value,
                    priceInput.value, imgUrlInput.value, referrerInput.value);
            resultInput.value = url;
            $('#prodimg').attr("src",imgUrlInput.value);
            set_bitly_url(url);
        }

        function makeUrl(url, title, price, img, source) {
            if (source === '') {
                alert("oops!  need a referrer!  just put any tracking string, like 'mancrate_coffee'.");
                return '';
            }
            return 'https://www.giftstarter.co/create?' + urlSerialize({
                        product_url: url,
                        title: title,
                        price: 100*price,
                        img_url: img,
                        source: source
                    });
        }

        function urlSerialize(obj) {
            var str = [];
            for(var p in obj)
                if (obj.hasOwnProperty(p)) {
                    str.push(encodeURIComponent(p) + "=" +
                    encodeURIComponent(obj[p]));
                }
            return str.join("&");
        }

        function set_bitly_url(long_url){
            $('#shortlink').val("");
            $.getJSON(
                "http://api.bitly.com/v3/shorten?callback=?",
                {
                    "format": "json",
                    "apiKey": "R_85bf9d10211f4423b5c3be4a336ad77d",
                    "login": "giftstarter",
                    "longUrl": long_url
                },
                function(response)
                {
                    $('#shortlink').val(response.data.url);
                }
            );
        }

    </script>
    <h1>Go GiftStarter!!!</h1>
    <div>
        <label for="url">Product URL</label><input type="text" id="url" required="" /><br>
        <label for="title">Product Title</label><input type="text" id="title" required="" /><br>
        <label for="image">Product Image URL</label><input type="text" id="image" required="" /><br>
        <label for="price">Product Price</label><input type="text" id="price" required="" /><br>
        <label for="source">Referrer (a tracking string)</label><input type="text" id="source" required="" /><br><br>
        <button id="submit" onclick="formSubmit()">Create Link</button><br><br>
        <label for="result">Result</label><input id="result"/><br><br>
        <label for="shortlink">Short</label><input id="shortlink"/><br><br>
        <img id="prodimg">
    </div>
</body>
</html>
